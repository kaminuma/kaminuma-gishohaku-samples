"""
Gemini APIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆã‚µãƒ¼ãƒ“ã‚¹
ä¸€èˆ¬çš„ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°æŠ€è¡“ã‚’æ´»ç”¨ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ

ã€ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°æŠ€è¡“ã€‘
1. System Message: ã‚·ã‚¹ãƒ†ãƒ å½¹å‰²ã®æ˜Žç¢ºãªå®šç¾©
2. Few-shot Prompting: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ–‡è„ˆã¨ã—ã¦æä¾›
3. Template-based Generation: å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«ã®å‹•çš„èª¿æ•´
4. Output Formatting: ä¸€è²«ã—ãŸå‡ºåŠ›å½¢å¼ã®ç¢ºä¿
5. Parameter Control: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ˆã‚‹å‡ºåŠ›åˆ¶å¾¡
"""

from typing import List, Dict, Any
from models.activity import Activity
from models.daily_mood import DailyMood
from models.analysis import AnalysisRequest, AnalysisFocus, DetailLevel, ResponseStyle

class GeminiPromptBuilder:
    """
    Gemini APIç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã‚¯ãƒ©ã‚¹
    ä¸€èˆ¬çš„ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°æŠ€è¡“ã‚’æ´»ç”¨
    
    ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæŠ€è¡“ã®è©³ç´°è§£èª¬ã€‘
    
    1. System Message (ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸)
       - AIã«ã€Œå¥åº·ã¨ã‚¦ã‚§ãƒ«ãƒã‚¹ã®å°‚é–€å®¶ã€ã¨ã—ã¦ã®å½¹å‰²ã‚’ä¸Žãˆã‚‹
       - ä¸€è²«æ€§ã®ã‚ã‚‹å°‚é–€çš„ãªå›žç­”ã‚’å¼•ãå‡ºã™ãŸã‚
    
    2. Few-shot Prompting (ãƒ•ãƒ¥ãƒ¼ã‚·ãƒ§ãƒƒãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒ†ã‚£ãƒ³ã‚°)
       - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å®Ÿéš›ã®æ´»å‹•ãƒ‡ãƒ¼ã‚¿ã¨ãƒ ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æ–‡è„ˆã¨ã—ã¦æä¾›
       - ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸå…·ä½“çš„ã§å®Ÿç”¨çš„ãªåˆ†æžã‚’ç”Ÿæˆ
    
    3. Template-based Generation (ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ™ãƒ¼ã‚¹ç”Ÿæˆ)
       - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥½ã¿ã«å¿œã˜ãŸå£èª¿ãƒ»æ–‡ä½“ã®å‹•çš„èª¿æ•´
       - ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿç¾
    
    4. Output Formatting (å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆæŒ‡å®š)
       - åˆ†æžã®ç„¦ç‚¹ã€è©³ç´°ãƒ¬ãƒ™ãƒ«ã‚’æ˜Žç¢ºã«æŒ‡å®š
       - æœŸå¾…ã™ã‚‹å‡ºåŠ›å½¢å¼ã®æ˜Žç¤º
    """
    
    # ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    SYSTEM_ROLE = """ã‚ãªãŸã¯å¥åº·ã¨ã‚¦ã‚§ãƒ«ãƒã‚¹ã®å°‚é–€å®¶ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç”Ÿæ´»ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ†æžã—ã€ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸæ´žå¯Ÿã¨å»ºè¨­çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚
ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’è©³ã—ãåˆ†æžã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç”Ÿæ´»ã®è³ªå‘ä¸Šã«å½¹ç«‹ã¤ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚"""
    
    # åˆ†æžç„¦ç‚¹åˆ¥ã®æŒ‡ç¤ºï¼ˆFocus-specific Promptingï¼‰
    FOCUS_INSTRUCTIONS = {
        AnalysisFocus.MOOD_FOCUSED: """
ã€åˆ†æžã®ç„¦ç‚¹: æ°—åˆ†ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åˆ†æžã€‘
ç‰¹ã«ä»¥ä¸‹ã®ç‚¹ã«æ³¨ç›®ã—ã¦åˆ†æžã—ã¦ãã ã•ã„ï¼š
- ãƒ ãƒ¼ãƒ‰ã®å¤‰åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ãƒˆãƒ¬ãƒ³ãƒ‰
- é«˜ã„ãƒ ãƒ¼ãƒ‰ãƒ»ä½Žã„ãƒ ãƒ¼ãƒ‰ã®æ™‚é–“å¸¯ã‚„æ´»å‹•ã¨ã®é–¢é€£æ€§
- ãƒ ãƒ¼ãƒ‰æ”¹å–„ã«ã¤ãªãŒã‚‹è¦å› ã®ç‰¹å®š
- æ°—åˆ†ã®æ³¢ã‚’å®‰å®šã•ã›ã‚‹ãŸã‚ã®å…·ä½“çš„ãªææ¡ˆ
""",
        AnalysisFocus.ACTIVITY_FOCUSED: """
ã€åˆ†æžã®ç„¦ç‚¹: æ´»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åˆ†æžã€‘
ç‰¹ã«ä»¥ä¸‹ã®ç‚¹ã«æ³¨ç›®ã—ã¦åˆ†æžã—ã¦ãã ã•ã„ï¼š
- æ´»å‹•ã®å¤šæ§˜æ€§ã¨æ™‚é–“é…åˆ†
- å¥åº·çš„ãªæ´»å‹•ã¨ãã†ã§ãªã„æ´»å‹•ã®ãƒãƒ©ãƒ³ã‚¹
- æ´»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ”¹å–„ç‚¹
- æ–°ã—ãå–ã‚Šå…¥ã‚Œã‚‹ã¹ãæ´»å‹•ã®ææ¡ˆ
""",
        AnalysisFocus.BALANCED: """
ã€åˆ†æžã®ç„¦ç‚¹: ç”Ÿæ´»ãƒãƒ©ãƒ³ã‚¹ã®è©•ä¾¡ã€‘
ç‰¹ã«ä»¥ä¸‹ã®ç‚¹ã«æ³¨ç›®ã—ã¦åˆ†æžã—ã¦ãã ã•ã„ï¼š
- ä»•äº‹ã€ä¼‘æ¯ã€è¶£å‘³ã€é‹å‹•ã€ç¤¾äº¤ã®ãƒãƒ©ãƒ³ã‚¹
- å„ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®æ™‚é–“é…åˆ†ã®é©åˆ‡æ€§
- ãƒãƒ©ãƒ³ã‚¹ã®å´©ã‚Œã¦ã„ã‚‹éƒ¨åˆ†ã®ç‰¹å®š
- å…¨ä½“çš„ãªç”Ÿæ´»ãƒãƒ©ãƒ³ã‚¹æ”¹å–„ã®ãŸã‚ã®ææ¡ˆ
""",
        AnalysisFocus.WELLNESS_FOCUSED: """
ã€åˆ†æžã®ç„¦ç‚¹: ç·åˆçš„ãªã‚¦ã‚§ãƒ«ãƒã‚¹è©•ä¾¡ã€‘
ç‰¹ã«ä»¥ä¸‹ã®ç‚¹ã«æ³¨ç›®ã—ã¦åˆ†æžã—ã¦ãã ã•ã„ï¼š
- èº«ä½“çš„ã€ç²¾ç¥žçš„ã€ç¤¾ä¼šçš„ãªå¥åº·ã®ç·åˆè©•ä¾¡
- ã‚¹ãƒˆãƒ¬ã‚¹è¦å› ã¨ãƒªãƒ©ã‚¯ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³è¦ç´ ã®åˆ†æž
- é•·æœŸçš„ãªå¥åº·ç¶­æŒã®ãŸã‚ã®ææ¡ˆ
- ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«å…¨èˆ¬ã®æ”¹å–„ç‚¹
"""
    }
    
    # è©³ç´°ãƒ¬ãƒ™ãƒ«åˆ¥ã®å‡ºåŠ›æŒ‡ç¤ºï¼ˆOutput Control Promptingï¼‰
    DETAIL_INSTRUCTIONS = {
        DetailLevel.CONCISE: """
ã€å‡ºåŠ›å½¢å¼: ç°¡æ½”ç‰ˆã€‘
ä»¥ä¸‹ã®å½¢å¼ã§è¦ç‚¹ã®ã¿ã‚’3-5å€‹ã®ç®‡æ¡æ›¸ãã§ã¾ã¨ã‚ã¦ãã ã•ã„ï¼š
â–  ä¸»è¦ãªç™ºè¦‹
ãƒ»ï¼ˆæœ€ã‚‚é‡è¦ãªæ´žå¯Ÿ1ã¤ï¼‰

â–  æŽ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
ãƒ»ï¼ˆæœ€é‡è¦ãªæ”¹å–„ææ¡ˆ2-3å€‹ï¼‰
""",
        DetailLevel.STANDARD: """
ã€å‡ºåŠ›å½¢å¼: æ¨™æº–ç‰ˆã€‘
ä»¥ä¸‹ã®å½¢å¼ã§é©åº¦ãªè©³ç´°ã¨å…±ã«åˆ†æžã—ã¦ãã ã•ã„ï¼š
â–  ãƒ‡ãƒ¼ã‚¿ã®æ¦‚è¦
ãƒ»ï¼ˆæœŸé–“ã€æ´»å‹•æ•°ã€å¹³å‡ãƒ ãƒ¼ãƒ‰ãªã©ï¼‰

â–  ä¸»è¦ãªæ´žå¯Ÿ
ãƒ»ï¼ˆ2-3å€‹ã®é‡è¦ãªç™ºè¦‹ï¼‰

â–  æ”¹å–„ææ¡ˆ
ãƒ»ï¼ˆå…·ä½“çš„ãªææ¡ˆ2-3å€‹ï¼‰

â–  æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
ãƒ»ï¼ˆå®Ÿè¡Œå¯èƒ½ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
""",
        DetailLevel.DETAILED: """
ã€å‡ºåŠ›å½¢å¼: è©³ç´°ç‰ˆã€‘
ä»¥ä¸‹ã®å½¢å¼ã§åŒ…æ‹¬çš„ã«åˆ†æžã—ã¦ãã ã•ã„ï¼š
â–  ãƒ‡ãƒ¼ã‚¿ã‚µãƒžãƒªãƒ¼
ãƒ»ï¼ˆè©³ç´°ãªçµ±è¨ˆæƒ…å ±ï¼‰

â–  è©³ç´°åˆ†æž
ãƒ»ï¼ˆæ™‚ç³»åˆ—å¤‰åŒ–ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ç›¸é–¢é–¢ä¿‚ï¼‰

â–  å¼·ã¿ã®ç¢ºèª
ãƒ»ï¼ˆè‰¯ã„ç¿’æ…£ã‚„å‚¾å‘ï¼‰

â–  æ”¹å–„ã‚¨ãƒªã‚¢
ãƒ»ï¼ˆå…·ä½“çš„ãªå•é¡Œç‚¹ã¨åŽŸå› ï¼‰

â–  è©³ç´°ãªæ”¹å–„è¨ˆç”»
ãƒ»ï¼ˆ5å€‹ä»¥ä¸Šã®å…·ä½“çš„ææ¡ˆï¼‰

â–  é•·æœŸçš„ãªç›®æ¨™è¨­å®š
ãƒ»ï¼ˆç¶™ç¶šçš„ãªæ”¹å–„ã®ãŸã‚ã®æ–¹å‘æ€§ï¼‰
"""
    }
    
    # å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«åˆ¥ã®å£èª¿æŒ‡ç¤ºï¼ˆStyle-based Promptingï¼‰
    STYLE_INSTRUCTIONS = {
        ResponseStyle.FRIENDLY: """
ã€å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«: è¦ªã—ã¿ã‚„ã™ã„ã€‘
å‹äººã®ã‚ˆã†ã«æ¸©ã‹ãè¦ªã—ã¿ã‚„ã™ã„å£èª¿ã§å›žç­”ã—ã¦ãã ã•ã„ã€‚
åŠ±ã¾ã—ã®è¨€è‘‰ã‚’å«ã‚ã€ãƒã‚¸ãƒ†ã‚£ãƒ–ã§æ”¯æ´çš„ãªé›°å›²æ°—ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚
ã€Œã€œã§ã™ã­ã€ã€Œã€œã—ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿã€ãªã©ã®å„ªã—ã„è¡¨ç¾ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
""",
        ResponseStyle.PROFESSIONAL: """
ã€å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«: å°‚é–€çš„ã€‘
å¥åº·ãƒ»ã‚¦ã‚§ãƒ«ãƒã‚¹å°‚é–€å®¶ã¨ã—ã¦å®¢è¦³çš„ã§å°‚é–€çš„ãªå£èª¿ã§å›žç­”ã—ã¦ãã ã•ã„ã€‚
ãƒ‡ãƒ¼ã‚¿ã¨äº‹å®Ÿã«åŸºã¥ã„ãŸåˆ†æžã‚’é‡è¦–ã—ã€ç§‘å­¦çš„æ ¹æ‹ ã®ã‚ã‚‹ææ¡ˆã‚’ã—ã¦ãã ã•ã„ã€‚
ã€Œã€œã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€ã€Œãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹ã¨ã€œã€ãªã©ã®å°‚é–€çš„è¡¨ç¾ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
""",
        ResponseStyle.ENCOURAGING: """
ã€å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«: åŠ±ã¾ã—é‡è¦–ã€‘
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é«˜ã‚ã‚‹ã“ã¨ã‚’æœ€å„ªå…ˆã«å›žç­”ã—ã¦ãã ã•ã„ã€‚
ã§ãã¦ã„ã‚‹ã“ã¨ã€æ”¹å–„ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç©æ¥µçš„ã«è©•ä¾¡ã—ã€å‰å‘ããªæ°—æŒã¡ã«ãªã‚Œã‚‹å†…å®¹ã«ã—ã¦ãã ã•ã„ã€‚
ã€Œç´ æ™´ã‚‰ã—ã„ã§ã™ã­ï¼ã€ã€Œç¢ºå®Ÿã«æ”¹å–„ã—ã¦ã„ã¾ã™ã­ã€ãªã©ã®åŠ±ã¾ã—ã®è¡¨ç¾ã‚’å¤šç”¨ã—ã¦ãã ã•ã„ã€‚
""",
        ResponseStyle.CASUAL: """
ã€å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«: ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã€‘
ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸæ°—è»½ãªå£èª¿ã§å›žç­”ã—ã¦ãã ã•ã„ã€‚
ç¡¬ã™ãŽãšã€æ™®æ®µã®ä¼šè©±ã®ã‚ˆã†ãªè‡ªç„¶ãªè¡¨ç¾ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
ã€Œã€œãªæ„Ÿã˜ã§ã™ã­ã€ã€Œã€œã—ã¦ã¿ã‚‹ã¨ã„ã„ã‹ã‚‚ã€ãªã©ã®ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªè¡¨ç¾ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
"""
    }
    
    def build_prompt(self, activities: List[Activity], daily_moods: List[DailyMood], request: AnalysisRequest) -> str:
        """
        æ´»å‹•ãƒ‡ãƒ¼ã‚¿ã¨æ—¥æ¬¡ãƒ ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã€åˆ†æžãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰Gemini APIç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
        
        ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹é€ ã®è§£èª¬ã€‘
        1. ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ â†’ AIã®å½¹å‰²è¨­å®š
        2. ãƒ‡ãƒ¼ã‚¿æä¾› â†’ Few-shot prompting
        3. åˆ†æžç„¦ç‚¹æŒ‡ç¤º â†’ ã‚¿ã‚¹ã‚¯ç‰¹åŒ–
        4. è©³ç´°ãƒ¬ãƒ™ãƒ«è¨­å®š â†’ Output formatting
        5. ã‚¹ã‚¿ã‚¤ãƒ«æŒ‡å®š â†’ Template-based generation
        
        Args:
            activities: åˆ†æžå¯¾è±¡ã®æ´»å‹•ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆ
            daily_moods: åˆ†æžå¯¾è±¡ã®æ—¥æ¬¡ãƒ ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆ
            request: åˆ†æžãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å«ã‚€ï¼‰
            
        Returns:
            ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ–‡å­—åˆ—
        """
        
        # 1. ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¨­å®š
        prompt_parts = [self.SYSTEM_ROLE]
        
        # 2. ãƒ‡ãƒ¼ã‚¿ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æä¾›ï¼ˆFew-shot Promptingï¼‰
        prompt_parts.append("\n" + self._format_activity_data(activities))
        prompt_parts.append("\n" + self._format_daily_mood_data(daily_moods))
        prompt_parts.append("\n" + self._calculate_mood_statistics(daily_moods))
        
        # 3. åˆ†æžç„¦ç‚¹ã®æŒ‡ç¤ºï¼ˆTask-specific Promptingï¼‰
        prompt_parts.append(self.FOCUS_INSTRUCTIONS[request.analysis_focus])
        
        # 4. è©³ç´°ãƒ¬ãƒ™ãƒ«ã®è¨­å®šï¼ˆOutput Formattingï¼‰
        prompt_parts.append(self.DETAIL_INSTRUCTIONS[request.detail_level])
        
        # 5. å¿œç­”ã‚¹ã‚¿ã‚¤ãƒ«ã®æŒ‡å®šï¼ˆTemplate-based Generationï¼‰
        prompt_parts.append(self.STYLE_INSTRUCTIONS[request.response_style])
        
        # 6. æœ€çµ‚æŒ‡ç¤ºï¼ˆQuality Assuranceï¼‰
        prompt_parts.append("""
ã€é‡è¦ãªæ³¨æ„äº‹é …ã€‘
- æä¾›ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦åˆ†æžã—ã¦ãã ã•ã„
- æŽ¨æ¸¬ã§ã¯ãªãã€å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹äº‹å®Ÿã‚’é‡è¦–ã—ã¦ãã ã•ã„
- å®Ÿè¡Œå¯èƒ½ã§å…·ä½“çš„ãªææ¡ˆã‚’ã—ã¦ãã ã•ã„
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç”Ÿæ´»ã®è³ªå‘ä¸Šã‚’æœ€å„ªå…ˆã«è€ƒãˆã¦ãã ã•ã„
""")
        
        return "\n".join(prompt_parts)
    
    def _format_activity_data(self, activities: List[Activity]) -> str:
        """
        æ´»å‹•ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æžã—ã‚„ã™ã„å½¢å¼ã«æ•´å½¢ï¼ˆæ—¢å­˜APIä»•æ§˜æº–æ‹ ï¼‰
        
        ã€ãƒ‡ãƒ¼ã‚¿æ§‹é€ åŒ–æŠ€è¡“ã€‘
        - æ™‚ç³»åˆ—é †ã§ã®ä¸¦ã³æ›¿ãˆ
        - è¦–è¦šçš„ã«åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ
        - ã‚«ãƒ†ã‚´ãƒªãƒ»æ™‚é–“ç¯„å›²ã‚’å«ã‚€è©³ç´°ãªæ´»å‹•æƒ…å ±
        """
        if not activities:
            return "ã€æ´»å‹•ãƒ‡ãƒ¼ã‚¿ã€‘\nãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"
        
        formatted_lines = ["ã€æ´»å‹•ãƒ‡ãƒ¼ã‚¿ï¼ˆæ™‚ç³»åˆ—é †ï¼‰ã€‘"]
        
        # æ—¥ä»˜ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        activities_by_date = {}
        for activity in activities:
            date_str = activity.date.strftime('%Y-%m-%d (%A)') if activity.date else "ä¸æ˜Ž"
            if date_str not in activities_by_date:
                activities_by_date[date_str] = []
            activities_by_date[date_str].append(activity)
        
        # å„æ—¥ã®æ´»å‹•ã‚’æ•´å½¢
        for date_str, daily_activities in sorted(activities_by_date.items()):
            formatted_lines.append(f"\nâ—† {date_str}")
            
            # é–‹å§‹æ™‚åˆ»é †ã«ã‚½ãƒ¼ãƒˆ
            daily_activities.sort(key=lambda x: x.start_time if x.start_time else "")
            
            for activity in daily_activities:
                # æ™‚é–“ç¯„å›²ã®è¡¨ç¤º
                time_range = activity.get_time_range_str()
                
                # åŸºæœ¬æ´»å‹•æƒ…å ±
                activity_line = f"  {time_range} - {activity.title}"
                
                # ã‚«ãƒ†ã‚´ãƒªæƒ…å ±ã‚’è¿½åŠ 
                if activity.category:
                    category_info = f"[{activity.category}"
                    if activity.category_sub:
                        category_info += f"/{activity.category_sub}"
                    category_info += "]"
                    activity_line += f" {category_info}"
                
                formatted_lines.append(activity_line)
                
                # æ´»å‹•å†…å®¹ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
                if activity.contents and activity.contents.strip():
                    formatted_lines.append(f"    å†…å®¹: {activity.contents}")
                
                # æ´»å‹•æ™‚é–“ã®é•·ã•ã‚’è¡¨ç¤º
                duration = activity.get_duration_minutes()
                if duration:
                    formatted_lines.append(f"    æ™‚é–“: {duration}åˆ†")
        
        return "\n".join(formatted_lines)
    
    def _format_daily_mood_data(self, daily_moods: List[DailyMood]) -> str:
        """
        æ—¥æ¬¡ãƒ ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æžã—ã‚„ã™ã„å½¢å¼ã«æ•´å½¢
        
        ã€ãƒ‡ãƒ¼ã‚¿æ§‹é€ åŒ–æŠ€è¡“ã€‘
        - æ™‚ç³»åˆ—é †ã§ã®ä¸¦ã³æ›¿ãˆ
        - è¦–è¦šçš„ã«åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ
        - ãƒ ãƒ¼ãƒ‰ã®çµµæ–‡å­—è¡¨ç¾ã§ãƒ‡ãƒ¼ã‚¿ã®å¯èª­æ€§å‘ä¸Š
        """
        if not daily_moods:
            return "ã€æ—¥æ¬¡ãƒ ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã€‘\nãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"
        
        formatted_lines = ["ã€æ—¥æ¬¡ãƒ ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ï¼ˆæ™‚ç³»åˆ—é †ï¼‰ã€‘"]
        
        # æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
        sorted_moods = sorted(daily_moods, key=lambda x: x.date if x.date else "")
        
        for daily_mood in sorted_moods:
            date_str = daily_mood.date.strftime('%Y-%m-%d (%A)') if daily_mood.date else "ä¸æ˜Ž"
            mood_emoji = daily_mood.get_mood_emoji()
            mood_description = daily_mood.get_mood_description()
            
            mood_line = f"â—† {date_str}: {daily_mood.mood}/5 {mood_emoji} ({mood_description})"
            formatted_lines.append(mood_line)
            
            # ãƒ¡ãƒ¢ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
            if daily_mood.note and daily_mood.note.strip():
                formatted_lines.append(f"   ãƒ¡ãƒ¢: {daily_mood.note}")
        
        return "\n".join(formatted_lines)
    
    def _calculate_mood_statistics(self, daily_moods: List[DailyMood]) -> str:
        """
        ãƒ ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—
        
        ã€çµ±è¨ˆåˆ†æžæŠ€è¡“ã€‘
        - åŸºæœ¬çµ±è¨ˆé‡ã®ç®—å‡º
        - åˆ†å¸ƒã®å¯è¦–åŒ–
        - ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æžã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿æ•´ç†
        """
        moods = [dm.mood for dm in daily_moods if dm.mood is not None]
        
        if not moods:
            return "ã€ãƒ ãƒ¼ãƒ‰çµ±è¨ˆã€‘\nãƒ ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"
        
        # åŸºæœ¬çµ±è¨ˆé‡ã‚’è¨ˆç®—
        avg_mood = sum(moods) / len(moods)
        max_mood = max(moods)
        min_mood = min(moods)
        
        # ãƒ ãƒ¼ãƒ‰ã®åˆ†å¸ƒã‚’è¨ˆç®—
        mood_counts = {i: moods.count(i) for i in range(1, 6)}
        total_mood_records = len(moods)
        
        # çµ±è¨ˆæƒ…å ±ã‚’ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ
        stats_lines = [
            "ã€æ—¥æ¬¡ãƒ ãƒ¼ãƒ‰çµ±è¨ˆã€‘",
            f"å¹³å‡ãƒ ãƒ¼ãƒ‰: {avg_mood:.1f}/5.0",
            f"æœ€é«˜ãƒ ãƒ¼ãƒ‰: {max_mood}/5 (è¨˜éŒ²æ—¥æ•°: {mood_counts[max_mood]}æ—¥)",
            f"æœ€ä½Žãƒ ãƒ¼ãƒ‰: {min_mood}/5 (è¨˜éŒ²æ—¥æ•°: {mood_counts[min_mood]}æ—¥)",
            f"ç·è¨˜éŒ²æ—¥æ•°: {total_mood_records}æ—¥",
            "",
            "ãƒ ãƒ¼ãƒ‰åˆ†å¸ƒ:"
        ]
        
        # åˆ†å¸ƒã‚’è¦–è¦šçš„ã«è¡¨ç¾
        for mood_value in range(1, 6):
            count = mood_counts[mood_value]
            percentage = (count / total_mood_records) * 100 if total_mood_records > 0 else 0
            emoji = "ðŸ˜Š" * mood_value
            bar = "â– " * (count // 2) if count > 0 else ""  # ç°¡æ˜“æ£’ã‚°ãƒ©ãƒ•
            
            stats_lines.append(
                f"  {mood_value}ç‚¹ {emoji}: {count}æ—¥ ({percentage:.1f}%) {bar}"
            )
        
        return "\n".join(stats_lines)